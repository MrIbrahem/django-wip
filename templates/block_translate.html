{% extends "base.html" %}
{% load staticfiles i18n %}

{% block head_title %}{% trans "block"|capfirst %}: {{ site.name }}{{ page_block.get_label }}{% endblock %}

{% block extra_head %}
<style>
h4 { margin: 0; padding: 0; }
form { margin: 0; padding: 0; }
table { margin: 0; padding: 0;}
label { font-size: small; }
.rounded-box {  border-radius: 10px;  border: 2px solid;  padding: 10px; }
.it { border: 1px solid; border-color: green; margin: 1px; }
.en { border: 1px solid; border-color: red; margin: 1px; }
.es { border: 1px solid; border-color: yellow; margin: 1px; }
.fr { border: 1px solid; border-color: blue; margin: 1px; }
</style>

<script>
function make_string (id) {
	s = document.getElementById(id).textContent;
	hidden = document.getElementById('segment');
	hidden.value = s;
	hidden.form.submit();
}
function translate_string (id) {
	s = document.getElementById(id).textContent;
	hidden = document.getElementById('string');
	hidden.value = s;
	hidden.form.submit();
}
function apply_translation (target_code, id_from, id_to) {
	segment = document.getElementById(id_from).textContent;
	translation = document.getElementById(id_to).textContent;
	textarea = document.getElementById(target_code);
	// text = textarea.textContent;
	text = textarea.value;
	tx_open = '<span tx man>';
	tx_close = '</span>';
	// pos = text.toLowerCase().indexOf(segment);
	pos = text.indexOf(segment);
	if (pos >= 0) {
		firstchar = text.charAt(pos);
		capfirst = (firstchar != firstchar.toLowerCase());
		if (capfirst) {
			translation = translation.charAt(0).toUpperCase() + translation.substring(1);
		}
		text = text.substring(0, pos) + tx_open + translation + tx_close + text.substring(pos+segment.length);
		textarea.value = text;
	}
}
</script>
{% endblock %}

{% block body_id %}block_translate{% endblock %}

{% block title-page %}{% trans "translate block"|capfirst %}{% endblock %}

{% block content-page %}
<blockquote>{{ page_block.get_label }}</blockquote>
  <table class="table table-responsive table-bordered table-striped mB5">
    <thead>
      <tr>
    	<th>{% trans "project"|capfirst %}</th>
    	<th>{% trans "block or project language"|capfirst %}</th>
    	<th>{% trans "block id"|capfirst %}</th>
    	<th>Checksum</th>
    	<th>{% trans "Date"|capfirst %}/{% trans "time"|capfirst %}</th>
      </tr>
    </thead>
    <tbody>
      <tr>
      	<td><span class="mR10">{{ site.name }}</span><a href="/site/{{ site.slug }}/"><i class="fa fa-th-large" aria-hidden="true"></i></a></td>
      	<td>{{ language }}</td>
      	<td>{{ page_block.id }}</td>
      	<td>{{ page_block.checksum }}</td>
      	<td>{{ page_block.time|date:"SHORT_DATETIME_FORMAT" }}</td>
      </tr>
    </tbody>
  </table>

{% comment %}
    <div><label>Project</label> <a href="/site/{{ site.slug }}/">{{ site.name }}</a></div>
    <div><label>Block or project language</label> {{ language }}
    <div><label>Block id</label> {{ page_block.id }}</div>
    <div><label>Checksum</label> {{ page_block.checksum }}</div>
    <div><label>Time</label> {{ page_block.time|date:"SHORT_DATETIME_FORMAT" }}</div>
{% endcomment %}

{% if user.is_superuser %}
<form class="mTB40" action="/block/{{ page_block.id }}/translate/{{ target_code }}/" method="post" style="margin: 0; padding: 0;">{% csrf_token %}
	<input type="hidden" id="segment" name="segment" value="">
	<input type="hidden" id="string" name="string" value="">

    <h4>{% trans "properties"|capfirst %}<span style="font-size: medium;">
		<label>Block language</label> {{ edit_form.language }} &nbsp;
		<label>Invariant</label> {{ edit_form.no_translate }} &nbsp;&nbsp;
		<input type="submit" name="save_block" value="Save properties" class="btn btn-default btn-sm">
		{% if not extract_strings %}<input type="submit" name="extract" class="btn btn-default btn-sm" value="Extract strings">{% endif %}
	</span></h4>

    <h4 style="margin: 0; padding: 0;">{% trans "navigation"|capfirst %}<span style="font-size: medium;">
   		<a class="btn btn-default btn-sm" href="/block/{{ page_block.id }}/">View</a>
		{% if previous %}<input type="submit" name="goto-{{ previous.id }}" class="btn btn-sm" value="Previous">{% endif %}
		{% if next %}<input type="submit" name="goto-{{ next.id }}" class="btn btn-sm" value="Next">{% endif %}
    </span></h4>

    <table class="table"><thead>
    	<tr>{% for field in sequencer_form.visible_fields %}<th style="padding-bottom:0; border-bottom-width:0">{{ field.label_tag }}</th>{% endfor %}</tr>
   	</thead><tbody><tr>
		<td style="border-top-width:0">{{ sequencer_form.webpage }}</td>
		{% comment %}<td style="border-top-width:0">{{ sequencer_form.block_age }}</td>{% endcomment %}
		<td style="border-top-width:0">{{ sequencer_form.translation_state }}</td>
		<td style="border-top-width:0">{{ sequencer_form.translation_languages }}</td>
		{% comment %}<td style="border-top-width:0">{{ sequencer_form.translation_age }}</td>{% endcomment %}
		<td style="border-top-width:0">{{ sequencer_form.source_text_filter }}</td>
	</tr></tbody></table>    	

	<table class="table">
	<thead>
	<tr><th style="border-bottom-width:0">Language</th><th style="width:50%; border-bottom-width:0">Block</th>
	{% if not page_block.no_translate %}
	<th style="width:48%; border-bottom-width:0" colspan="2">Segments{% if extract_strings %} and strings{% endif %}</th>
	{% endif %}
	</tr>
	</thead>
	<tbody>
	<tr><td style="border-top-width:0;">Source</td><td style="border-top-width:0;"><div class="rounded-box {{ page_block.get_language.code }}">{{ page_block.normalized_body }}</div></td>
	<td style="vertical-align: top; border-top-width:0;">
	{% if not page_block.no_translate %}
		<table class="table"><tbody>
		{% for segment, strings, translations in source_segments %}
		<tr><td style="vertical-align: top; border-top-color:transparent;"><code>{{forloop.counter|rjust:"3"}}</code> {% if segment.id %}<span  id="str-{{ forloop.counter }}" style="font-weight: bold;">{{ segment.text }}</span> &nbsp;
			 	<button type="submit" onclick="translate_string('str-{{ forloop.counter }}'); return false;" class="fa fa-language" style="background-color: white; color: blue; border: none;" title="translate this string" />
				{% else %}<span id="seg-{{ forloop.counter }}">{{ segment }}</span> &nbsp;
				<button type="submit" onclick="make_string('seg-{{ forloop.counter }}'); return false;" class="fa fa-caret-square-o-up" style="background-color: transparent; color: #006BB1; border: none;" title="extract this string" />
				{% endif %}</td></tr>
		{% for t in translations %}
		<tr><td><span id="tra-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" class="{{ target_code }}">{{ t.text }}</span>
				<a onclick="apply_translation('{{ target_code }}', 'str-{{ forloop.parentloop.counter }}', 'tra-{{ forloop.parentloop.counter }}-{{ forloop.counter }}'); return true;" class="fa fa-check" style="background-color: white; color: blue; border: none;" title="apply this translation" /></td></tr>
		{% endfor %}
		{% endfor %}
		</tbody></table>
	{% endif %}
	</td>
	</tr>
	{% if not page_block.no_translate %}
	<tr><td style="vertical-align: top; border-top-color:transparent;">{{ target_language.name }}</td>
	<td style="vertical-align: top; border-top-color:transparent;">
	{% if translated_block %}
	<textarea id="{{ target_code }}" name="translation-{{ target_code }}" class="rounded-box {{ target_code }}" style="width: 96%; height:100px; margin-top: 0.5em;">{{ translated_block.normalized_body }}</textarea>
	<input type="submit" value="Modify translation" name="modify-{{ target_code }}" />
	{% else %}
	<textarea id="{{ target_code }}" name="translation-{{ target_code }}" name="translation-{{ target_code }}"  style="width: 96%; height:100px;">{{ page_block.normalized_body }}</textarea>
	<input type="submit" class="btn btn-sm" value="Create translation" name="create-{{ target_code }}" />
	{% endif %}
	</td>
	<td style="vertical-align: top; border-top-color:transparent;">{% for strings in segment_strings %}
		{% if strings %}<div><code>{{forloop.counter|rjust:"3"}}</code></div>
		{% for string in strings %}<div style="font-style: italic; font-size: small; margin-left: 1.8em;">{{ string.text }}</div>{% endfor %}
		{% endif %}
	{% endfor %}</td>
	</tr>
	{% comment %}{% endfor %}{% endcomment %}
	{% endif %}
	</tbody>
	</table>
</form>
{% endif %}
{% endblock %}
