{% extends "wip_base.html" %}
{% load staticfiles i18n %}

{% block extra_head %}
<style>
label { display: inline; font-weight: bold; margin-right: 1.0em; padding: 0.2em 0em; }
pre { display: inline;  padding: 0; }
pre code { display: inline; }
.rounded-box {  border-radius: 10px;  border: 2px solid;  padding: 10px; }
.it { border: 1px solid; border-color: green; margin: 1px; }
.en { border: 1px solid; border-color: red; margin: 1px; }
.es { border: 1px solid; border-color: yellow; margin: 1px; }
.fr { border: 1px solid; border-color: blue; margin: 1px; }   
tx.en {color: red; }
tx.fr {color: blue; }
th, td { text-align: left; vertical-align: top; }
</style>
<script>
function make_string (id) {
	s = document.getElementById(id).textContent;
	hidden = document.getElementById('segment');
	hidden.value = s;
	hidden.form.submit();
}
function translate_string (id) {
	s = document.getElementById(id).textContent;
	hidden = document.getElementById('string');
	hidden.value = s;
	hidden.form.submit();
}
function apply_translation (target_code, id_from, id_to) {
	segment = document.getElementById(id_from).textContent;
	translation = document.getElementById(id_to).textContent;
	textarea = document.getElementById(target_code);
	text = textarea.textContent;
	tx_open = '<tx class="' + target_code + '">';
	tx_close = '</tx>';
	pos = text.toLowerCase().indexOf(segment);
	if (pos >= 0) {
		firstchar = text.charAt(pos);
		capfirst = (firstchar != firstchar.toLowerCase());
		if (capfirst) {
			translation = translation.charAt(0).toUpperCase() + translation.substring(1);
		}
		text = text.substring(0, pos) + tx_open + translation + tx_close + text.substring(pos+segment.length);
		textarea.value = text;
	}
}
</script>
{% endblock %}

{% block head_title %}Block: {{ site.name }}{{ page_block.get_label }}{% endblock %}

{% block title-page %}<span style="color: black; font-size: smaller;">Translate block:</span> <span style="font-size: small;">{{ page_block.get_label }}</span>{% endblock %}

{% block content-page %}
    <div><label>Site</label> <a href="/site/{{ site.slug }}/">{{ site.name }}</a></div>
    <div><label>Block or site language</label> {{ language }}
    <div><label>Block id</label> {{ page_block.id }}</div>
    <div><label>Checksum</label> {{ page_block.checksum }}</div>
    <div><label>Time</label> {{ page_block.time|date:"SHORT_DATETIME_FORMAT" }}</div>

<form action="/block/{{ page_block.id }}/translate/{{ target_code }}/" method="post">{% csrf_token %}
	<input type="hidden" id="segment" name="segment" value="" />
	<input type="hidden" id="string" name="string" value="" />
    <div style="vertical-align: middle;">
		<label>Block language</label> {{ edit_form.language }} &nbsp;
		<label>Invariant</label> {{ edit_form.no_translate }} &nbsp;&nbsp;
		{% if user.is_superuser %}
		<input type="submit" name="save_block" value="Save properties" class="btn btn-sm" />
		{% endif %}
    <div>
		<a class="btn btn-sm" href="/block/{{ page_block.id }}/">View</a>
 		{% if not extract_strings %}<input type="submit" name="extract" class="btn btn-sm" value="Extract strings">{% endif %}
	</div>

{% if user.is_superuser %}
    <div>
		<input type="submit" name="apply_filter" class="btn btn-sm" value="Apply filter below"> &nbsp;&nbsp;
		{% if previous %}<input type="submit" name="goto-{{ previous.id }}" class="btn btn-sm" value="Previous">{% endif %}
		{% if next %}<input type="submit" name="goto-{{ next.id }}" class="btn btn-sm" value="Next">{% endif %}
    </div>
    <table><thead>
    	<tr>{% for field in sequencer_form.visible_fields %}<th>{{ field.label_tag }}</th>{% endfor %}</tr>
   	</thead><tbody><tr>
		<td>{{ sequencer_form.webpage }}</td>
		<td>{{ sequencer_form.block_age }}</td>
		<td>{{ sequencer_form.translation_state }}</td>
		<td>{{ sequencer_form.translation_languages }}</td>
		<td>{{ sequencer_form.translation_age }}</td>
		<td>{{ sequencer_form.extract_strings }}</td>
	</tr></tbody></table>    	
	</form>
{% endif %}

	<table style="border-collapse: separate; border-spacing: 5px;">
	<thead>
	<tr><th width="6%">language</th><th width="50%">block</th>
	{% if not page_block.no_translate %}
	<th width="44%" colspan="2">segments{% if extract_strings %} and strings{% endif %}</th>
	{% endif %}
	</tr>
	</thead>
	<tbody>
	<tr style="vertical-align: top;"><td>Source</td><td><div class="rounded-box {{ page_block.get_language.code }}">{{ page_block.body }}</div></td>
	<td style="vertical-align: top;">
	{% if not page_block.no_translate %}
		<table style="cell-padding: 2px;"><tbody>
		{% for segment, strings, language_translations in source_segments %}
		<tr><td style="vertical-align: top;"><code>{{forloop.counter|rjust:"3"}}</code></td>
			<td>{% if segment.id %}<span  id="str-{{ forloop.counter }}" style="font-weight: bold;">{{ segment.text }}</span> &nbsp;
			 	<button type="submit" onclick="translate_string('str-{{ forloop.counter }}'); return false;" class="fa fa-language" style="background-color: white; color: blue; border: none;" title="translate this string" />
				{% else %}<span id="seg-{{ forloop.counter }}">{{ segment }}</span> &nbsp;
				<button type="submit" onclick="make_string('seg-{{ forloop.counter }}'); return false;" class="fa fa-caret-square-o-up" style="background-color: white; color: blue; border: none;" title="extract this string" />
				{% endif %}</td></tr>
		{% for language, translations in language_translations %}{% for t in translations %}
		<tr><td></td><td><span   id="tra-{{ forloop.counter }}" class="{{ language.code }}">{{ t.text }}</span>
				<a onclick="apply_translation('{{ language.code }}', 'str-{{ forloop.parentloop.parentloop.counter }}', 'tra-{{ forloop.counter }}'); return true;" class="fa fa-check" style="background-color: white; color: blue; border: none;" title="apply this translation" /></td></tr>
		{% endfor %}{% endfor %}
		{% for score, string in strings %}
		<tr><td></td><td style="font-style: italic; font-size: small;">{{ score|floatformat:2 }} {{ string.text }}</td></tr>
		{% endfor %}
		{% endfor %}
		</tbody></table>
	{% endif %}
	</td>
	</tr>
	{% if not page_block.no_translate %}
	{% comment %}{% for language, block, segment_strings in target_list %}{% endcomment %}
	<tr style="vertical-align: top;"><td>{{ target_language.name }}</td>
	<td>
	{% if translated_block %}
	<textarea id="{{ target_code }}" name="translation-{{ target_code }}" class="rounded-box {{ target_code }}" style="width: 96%; height:100px; margin-top: 0.5em;">{{ translated_block.body }}</textarea>
	<input type="submit" value="Modify translation" name="modify-{{ target_code }}" />
	{% else %}
	<textarea id="{{ target_code }}" name="translation-{{ target_code }}" name="translation-{{ target_code }}"  style="width: 96%; height:100px;">{{ page_block.body }}</textarea>
	<input type="submit" class="btn btn-sm" value="Create translation" name="create-{{ target_code }}" />
	{% endif %}
	</td>
	<td style="vertical-align: top;">{% for strings in segment_strings %}
		{% if strings %}<div><code>{{forloop.counter|rjust:"3"}}</code></div>
		{% for string in strings %}<div style="font-style: italic; font-size: small; margin-left: 1.8em;">{{ string.text }}</div>{% endfor %}
		{% endif %}
	{% endfor %}</td>
	</tr>
	{% comment %}{% endfor %}{% endcomment %}
	{% endif %}
	</tbody>
	</table>
</form>
{% endblock %}
